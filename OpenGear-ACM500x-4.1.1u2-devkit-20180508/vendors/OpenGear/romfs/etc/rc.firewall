#!/bin/sh

source /etc/scripts/mutex

IPTABLES="/bin/iptables"

MODEL=`config -g config.system.model | cut -f2 -d' '`

if [ "$MODEL" = "IMG4216-25" ]; then
	OOB_IP=$(ifconfig eth1:0 2> /dev/null | grep inet\ addr | cut -f2 -d':' | cut -f1 -d' ')
	MGMT_IP=$(ifconfig eth1 2> /dev/null | grep inet\ addr | cut -f2 -d':' | cut -f1 -d' ')
fi

MGMTLAN_IN=MgmtLanInput
MGMTLAN_OUT=MgmtLanOutput
OOB_IN=OobInput
OOB_OUT=OobOutput

DYNADDR_IN=DynAddrInput
DYNADDR_FORWARD=DynAddrForward

export CASCADE=Cascade
export CASCADENAT=CascadeNat
export CASCADEMASQ=CascadeMasq

# Script paths
CUSTOMFILE=/etc/config/filter-custom
CASCADEFILE=/etc/config/filter-cascade
RULESFILE=/etc/config/fw.rules
IPPASSTHROUGH=/etc/config/fw.ippassthrough

# Run custom rules and exit if user script exists
if [ -f ${CUSTOMFILE} ]; then
	. ${CUSTOMFILE}
	exit 0
fi

cat /etc/config/fw.rules | iptables-restore

# Enable IP forwarding between network interfaces
echo 1 > /proc/sys/net/ipv4/ip_forward

if [ ! -z "${MGMT_IP}" ]; then
	${IPTABLES} -A ${DYNADDR_IN} --destination ${MGMT_IP} -j ${MGMTLAN_IN}
fi

if [ ! -z "${OOB_IP}" ]; then
	${IPTABLES} -A ${DYNADDR_IN} --destination ${OOB_IP} -j ${OOB_IN}
fi

if [ -f ${CASCADEFILE} ]; then
	. ${CASCADEFILE}
fi

if [ -f ${IPPASSTHROUGH} ]; then
	. ${IPPASSTHROUGH}
fi

#
# Run custom post firewall rules
#
if [ -f /etc/config/scripts/firewall-post ]; then
	/bin/sh /etc/config/scripts/firewall-post
fi

