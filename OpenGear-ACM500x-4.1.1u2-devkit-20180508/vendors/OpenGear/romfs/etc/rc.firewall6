#!/bin/sh

source /etc/scripts/mutex

export IPTABLES=/bin/ip6tables

# Script paths
CUSTOMFILE=/etc/config/filter6-custom


# If IPv6 is disabled, drop everything
ipv6_enabled=$(config -g config.system.ipv6.enabled | cut -f2- -d' ')
if [ -z "$ipv6_enabled" ]; then

	${IPTABLES} -F
	${IPTABLES} -X

	# Default policies for built in chains
	for CHAIN in FORWARD INPUT OUTPUT; do
		${IPTABLES} --policy ${CHAIN} DROP
	done

	${IPTABLES} -A INPUT --in-interface lo -j ACCEPT
	${IPTABLES} -A OUTPUT --out-interface lo -j ACCEPT

	exit 0
fi


# Run custom rules and exit if user script exists
if [ -f ${CUSTOMFILE} ]; then
	. ${CUSTOMFILE}
	exit 0
fi

cat /etc/config/fwipv6.rules | ip6tables-restore
